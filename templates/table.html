{% extends "base.html" %}

{% block title %}Heritage Results Database - Batch {{ batch }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="container-custom p-4 fade-in-up">
        
        <!-- Page Header -->
        <div class="row align-items-center mb-4">
            <!-- Left side - Batch Title -->
            <div class="col-md-6">
                <h2 class="title-text mb-3 text-start d-none d-md-block">Batch {{ batch }} Results</h2>
                
                <!-- Disclaimer -->
                <div class="mt-2 disclaimer-container">
                    <small class="text-muted disclaimer-text">
                        <i class="fas fa-info-circle me-1"></i>
                        This website is not affiliated with Heritage Institute of Technology
                    </small>
                </div>
            </div>
            
            <!-- Right side - Filters Toggle and Results Summary -->
            <div class="col-md-6 text-md-end text-center mt-3 mt-md-0">
                <!-- Collapsible Filters Toggle Button -->
                <div class="mb-2">
                    <button 
                        class="btn btn-primary-nord filters-toggle-btn" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#filtersCollapse" 
                        aria-expanded="false" 
                        aria-controls="filtersCollapse"
                    >
                        <i class="fas fa-filter me-2"></i>Show Filters & Search
                        <i class="fas fa-chevron-down ms-2"></i>
                    </button>
                </div>
                
                <!-- Quick Results Summary -->
                <div class="text-break">
                    <span class="fs-6 text-muted pe-2 results-summary results-count" style="font-weight: var(--font-weight-medium);">
                        <strong>{{ data|length }}</strong> result{{ 's' if data|length != 1 else '' }} found
                        {% if search_query %} | Search: "{{ search_query }}"{% endif %}
                        {% if sort_by %} | Sorted by {{ sort_by }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Collapsible Filters Section -->
        <div class="collapse" id="filtersCollapse">
            <div class="card card-body mb-4" style="background: var(--nord6); border: 1px solid var(--nord4); border-radius: var(--border-radius-md);">
                
                <!-- Search and Filter Section -->
                {% include 'components/search_filter.html' %}
                
                <!-- Branch Filter Section -->
                {% include 'components/branch_filter.html' %}

                <!-- Sorting Options -->
                <div class="mb-3">
                    <h5 class="text-nord1 mb-3 sort-heading">
                        <i class="fas fa-sort me-2"></i>Sort by
                    </h5>
            
            <form method="GET" class="d-flex flex-wrap gap-2">
                <!-- Preserve filters -->
                {% for branch in selected_branches %}
                <input type="hidden" name="branch" value="{{ branch }}">
                {% endfor %}
                {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
                {% endif %}

                <!-- Sort options based on batch -->
                {% if batch == "2024" %}
                    {% set sort_options = [
                        ("Rank", "Rank (yGPA)"),
                        ("yGPA 1", "yGPA 1"),
                        ("GPA Sem 1", "GPA Sem 1"),
                        ("GPA Sem 2", "GPA Sem 2")
                    ] %}
                {% elif batch == "2023" %}
                    {% set sort_options = [
                        ("Rank", "Rank (Avg YGPA)"),
                        ("YGPA 1", "YGPA 1"),
                        ("YGPA 2", "YGPA 2"),
                        ("CGPA 1", "CGPA 1"),
                        ("CGPA 2", "CGPA 2"),
                        ("CGPA 3", "CGPA 3"),
                        ("CGPA 4", "CGPA 4")
                    ] %}
                {% elif batch == "2022" %}
                    {% set sort_options = [
                        ("Rank", "Rank (Avg YGPA)"),
                        ("YGPA 1", "YGPA 1"),
                        ("YGPA 2", "YGPA 2"),
                        ("YGPA 3", "YGPA 3"),
                        ("CGPA 1", "CGPA 1"),
                        ("CGPA 2", "CGPA 2"),
                        ("CGPA 3", "CGPA 3"),
                        ("CGPA 4", "CGPA 4"),
                        ("CGPA 5", "CGPA 5"),
                        ("CGPA 6", "CGPA 6")
                    ] %}
                {% endif %}

                {% for value, label in sort_options %}
                <button 
                    type="submit" 
                    name="sort_by" 
                    value="{{ value }}"
                    class="btn btn-sort {{ 'active' if sort_by == value else '' }}"
                >
                    {{ label }}
                    {% if sort_by == value %}
                        <i class="fas fa-sort-{{ 'down' if order == 'desc' else 'up' }} ms-1"></i>
                    {% endif %}
                </button>
                {% endfor %}
                {% if sort_by %}
                <button 
                    type="submit" 
                    name="order" 
                    value="{{ 'asc' if order == 'desc' else 'desc' }}"
                    class="btn btn-filter"
                >
                    <i class="fas fa-exchange-alt me-1"></i>
                    {{ 'Ascending' if order == 'desc' else 'Descending' }}
                </button>
                {% endif %}
            </form>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-nord">
                    <thead>
                        <!-- Top header row with grouped categories -->
                        <tr>
                            <th rowspan="2" class="align-middle">Rank</th>
                            <th rowspan="2" class="align-middle">Name</th>
                            <th rowspan="2" class="align-middle">{{ 'Branch' if (data and 'Branch' in data[0]) else 'Department' }}</th>
                            
                            <!-- Dynamic grouped headers based on batch -->
                            {% if batch == "2024" %}
                                <th colspan="2" class="text-center">SGPA</th>
                                <th colspan="1" class="text-center">YGPA</th>
                            {% elif batch == "2023" %}
                                <th colspan="4" class="text-center">CGPA</th>
                                <th colspan="3" class="text-center">YGPA</th>
                            {% elif batch == "2022" %}
                                <th colspan="6" class="text-center">CGPA</th>
                                <th colspan="4" class="text-center">YGPA</th>
                            {% endif %}
                        </tr>
                        
                        <!-- Bottom header row with specific semesters -->
                        <tr>
                            {% if batch == "2024" %}
                                <th class="text-center">1st</th>
                                <th class="text-center">2nd</th>
                                <th class="text-center">1st</th>
                            {% elif batch == "2023" %}
                                <th class="text-center">1st</th>
                                <th class="text-center">2nd</th>
                                <th class="text-center">3rd</th>
                                <th class="text-center">4th</th>
                                <th class="text-center">1st</th>
                                <th class="text-center">2nd</th>
                                <th class="text-center">Avg</th>
                            {% elif batch == "2022" %}
                                <th class="text-center">1st</th>
                                <th class="text-center">2nd</th>
                                <th class="text-center">3rd</th>
                                <th class="text-center">4th</th>
                                <th class="text-center">5th</th>
                                <th class="text-center">6th</th>
                                <th class="text-center">1st</th>
                                <th class="text-center">2nd</th>
                                <th class="text-center">3rd</th>
                                <th class="text-center">Avg</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td>{{ row.Rank }}</td>
                            <td>{{ row.Name }}</td>
                            <td>{{ row.get('Branch', row.get('Department', 'N/A')) }}</td>
                            
                            <!-- Dynamic data based on batch -->
                            {% if batch == "2024" %}
                                <td>{{ row.get('GPA Sem 1', 'N/A') }}</td>
                                <td>{{ row.get('GPA Sem 2', 'N/A') }}</td>
                                <td>{{ row.get('yGPA 1', 'N/A') }}</td>
                            {% elif batch == "2023" %}
                                <td>{{ row.get('CGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 3', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 4', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 2', 'N/A') }}</td>
                                <td>
                                    {% set ygpa1 = row.get('YGPA 1', 0) | float %}
                                    {% set ygpa2 = row.get('YGPA 2', 0) | float %}
                                    {{ "%.2f" | format((ygpa1 + ygpa2) / 2) if ygpa1 and ygpa2 else 'N/A' }}
                                </td>
                            {% elif batch == "2022" %}
                                <td>{{ row.get('CGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 3', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 4', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 5', 'N/A') }}</td>
                                <td>{{ row.get('CGPA 6', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 3', 'N/A') }}</td>
                                <td>
                                    {% set ygpa1 = row.get('YGPA 1', 0) | float %}
                                    {% set ygpa2 = row.get('YGPA 2', 0) | float %}
                                    {% set ygpa3 = row.get('YGPA 3', 0) | float %}
                                    {{ "%.2f" | format((ygpa1 + ygpa2 + ygpa3) / 3) if ygpa1 and ygpa2 and ygpa3 else 'N/A' }}
                                </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="20" class="text-center text-muted">
                                <i class="fas fa-search me-2"></i>No results found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Results Summary -->
        {% if data %}
        <div class="mt-4 text-center">
            <small class="text-muted">
                Showing {{ data|length }} result{{ 's' if data|length != 1 else '' }}
                {% if search_query %}for search "{{ search_query }}"{% endif %}
                {% if selected_branches %}in {{ selected_branches|join(', ') }}{% endif %}
            </small>
        </div>
        {% endif %}

        <!-- Footer inside white container -->
        <div class="text-center">
            {% include 'components/footer.html' %}
        </div>
        <!-- Back to Top Button -->
        <button id="backToTop" class="btn btn-back-to-top" aria-label="Back to top">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>
    </div>
    {% endblock %}

{% block footer %}
<!-- Footer moved inside page content -->
{% endblock %}

{% block scripts %}
<!-- Filter collapse behavior -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtersCollapse = document.getElementById('filtersCollapse');
    const toggleButton = document.querySelector('[data-bs-target="#filtersCollapse"]');
    const buttonText = toggleButton.querySelector('span') || toggleButton.childNodes[2]; // Text node after icon
    const chevronIcon = toggleButton.querySelector('.fa-chevron-down, .fa-chevron-up');
    
    if (filtersCollapse && toggleButton) {
        filtersCollapse.addEventListener('show.bs.collapse', function() {
            // Change button text and icon when expanding
            toggleButton.innerHTML = '<i class="fas fa-filter me-2"></i>Hide Filters & Search<i class="fas fa-chevron-up ms-2"></i>';
        });
        
        filtersCollapse.addEventListener('hide.bs.collapse', function() {
            // Change button text and icon when collapsing
            toggleButton.innerHTML = '<i class="fas fa-filter me-2"></i>Show Filters & Search<i class="fas fa-chevron-down ms-2"></i>';
        });
    }
    
    console.log('Heritage Results Database loaded');
    console.log('Found', document.querySelectorAll('button[type="submit"]').length, 'submit buttons');
    console.log('Found', document.querySelectorAll('form').length, 'forms');

    // Back to Top button functionality
    const backToTopBtn = document.getElementById('backToTop');
    if (backToTopBtn) {
        const showThreshold = 300; // px
        const handleScroll = () => {
            if (window.scrollY > showThreshold) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        };
        window.addEventListener('scroll', handleScroll, { passive: true });
        handleScroll();
        backToTopBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    } else {
        console.warn('Back to Top button not found in DOM');
    }

    // Abbreviate Branch/Department names on phones
    const isPhone = () => window.innerWidth < 576;

    // Exact mapping from dataset Branch to short code
    const BRANCH_CODE_MAP = {
        'Computer Science & Engineering': 'CSE',
        'Electronics & Communication Engineering': 'ECE',
        'Applied Electronics & Instrumentation Engineering': 'AEIE',
        'Information Technology': 'IT',
        'Chemical Engineering': 'ChE',
        'Biotechnology': 'BT',
        'Mechanical Engineering': 'ME',
        'Civil Engineering': 'CE',
        'Electrical Engineering': 'EE',
        'Computer Science & Business Systems': 'CSBS',
        'Computer Science & Engineering (AI&ML)': 'AIML',
        'Computer Science & Engineering (Data Science)': 'DS',
        'Computer Science and Engineering (IoT)': 'IoT'
    };

    // Legacy generic map used only as a fallback for unknown/new labels
    const BRANCH_MAP = {
        'computer science and engineering': 'CSE',
        'information technology': 'IT',
        'electronics & communication engineering': 'ECE',
        'electronics and communication engineering': 'ECE',
        'electrical engineering': 'EE',
        'applied electronics & instrumentation engineering': 'AEIE',
        'applied electronics and instrumentation engineering': 'AEIE',
        'mechanical engineering': 'ME',
        'civil engineering': 'CE',
        'chemical engineering': 'CHE',
        'biotechnology': 'BT'
    };

    const acronym = (text) => {
        if (!text) return '';
        // Handle patterns like "CSE (Data Science)" => "CSE-DS"
        const cseMatch = text.match(/^\s*CSE\s*\(([^)]+)\)/i);
        if (cseMatch) {
            return 'CSE-' + acronym(cseMatch[1]);
        }
        const lower = text.toLowerCase().trim();
        if (BRANCH_MAP[lower]) return BRANCH_MAP[lower];
        // Remove parentheses for acronymming
        const cleaned = lower.replace(/[()]/g, ' ');
        const stop = new Set(['and','of','the','in','for','&','engineering','dept','department']);
        const parts = cleaned.split(/[^a-z0-9+]+/i).filter(Boolean);
        const letters = parts
            .filter(w => !stop.has(w))
            .map(w => {
                // Keep existing shortcodes like CSE, ECE
                if (/^[a-z]{2,4}$/.test(w) && BRANCH_MAP[w]) return BRANCH_MAP[w];
                // e.g., 'ee' 'ece'
                if (/^[a-z]{2,4}$/.test(w) && w === w.toLowerCase()) return w[0];
                return w[0];
            })
            .join('');
        const up = letters.toUpperCase();
        // Fallback for single long word (e.g., Biotechnology)
        if (!up || up.length === 1) {
            if (BRANCH_MAP[lower]) return BRANCH_MAP[lower];
            if (parts.length === 1 && parts[0].length >= 8) return parts[0].slice(0,2).toUpperCase();
        }
        return up;
    };

    const findBranchColIndex = (table) => {
        const headRow = table.querySelector('thead tr');
        if (!headRow) return -1;
        const ths = Array.from(headRow.querySelectorAll('th'));
        let index = 0;
        for (const th of ths) {
            const label = th.textContent.trim().toLowerCase();
            if (label === 'branch' || label === 'department') return index;
            const colspan = parseInt(th.getAttribute('colspan') || '1', 10);
            index += colspan;
        }
        return -1;
    };

    const applyBranchAbbrev = () => {
        const table = document.querySelector('table.table-nord');
        if (!table) return;
        const colIndex = findBranchColIndex(table);
        if (colIndex < 0) return;
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            const td = cells[colIndex];
            if (!td) return;
            if (!td.dataset.fullText) {
                td.dataset.fullText = (td.textContent || '').trim();
            }
            const full = td.dataset.fullText;
            if (!full) return;
            if (isPhone()) {
                // Prefer exact mapping
                const codeExact = BRANCH_CODE_MAP[full];
                if (codeExact) {
                    td.textContent = codeExact;
                    td.title = full;
                } else {
                    const abbr = acronym(full);
                    if (abbr && abbr.length) {
                        td.textContent = abbr;
                        td.title = full;
                    }
                }
            } else {
                td.textContent = full;
                td.removeAttribute('title');
            }
        });
    };

    // Initial apply and on resize (debounced)
    applyBranchAbbrev();

    // Abbreviate branch filter buttons in the search menu on phones
    const applyBranchFilterAcronyms = () => {
        const form = document.getElementById('branchFilterForm');
        if (!form) return;
        const buttons = form.querySelectorAll('button[name="branch"]');
        buttons.forEach(btn => {
            const full = (btn.dataset.fullLabel || btn.textContent || '').trim();
            if (!btn.dataset.fullLabel) btn.dataset.fullLabel = full;
            if (!full) return;
            if (isPhone()) {
                const exact = BRANCH_CODE_MAP[full];
                if (exact) {
                    btn.textContent = exact;
                    btn.title = full;
                } else {
                    const abbr = acronym(full);
                    if (abbr) {
                        btn.textContent = abbr;
                        btn.title = full;
                    }
                }
            } else {
                btn.textContent = btn.dataset.fullLabel;
                btn.removeAttribute('title');
            }
        });
    };

    applyBranchFilterAcronyms();

    if (filtersCollapse) {
        // Also refresh when filters are opened (in case loaded closed)
        filtersCollapse.addEventListener('show.bs.collapse', applyBranchFilterAcronyms);
    }

    let resizeTO;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTO);
        resizeTO = setTimeout(() => {
            applyBranchAbbrev();
            applyBranchFilterAcronyms();
        }, 120);
    }, { passive: true });
});
</script>
{% endblock %}
