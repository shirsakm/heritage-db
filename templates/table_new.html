{% extends "base.html" %}

{% block title %}Heritage Results Database - Batch {{ batch }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/table.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="container-custom p-4 fade-in-up">
        
        <!-- Page Header -->
        <div class="text-center mb-4">
            <h2 class="title-text">Batch {{ batch }} Results</h2>
            <p class="subtitle-text">Search and filter student results</p>
        </div>

        <!-- Search and Filter Section -->
        {% include 'components/search_filter.html' %}
        
        <!-- Branch Filter Section -->
        {% include 'components/branch_filter.html' %}

        <!-- Sorting Options -->
        <div class="mb-4">
            <h5 class="text-nord1 mb-3">
                <i class="fas fa-sort me-2"></i>Sort Results
            </h5>
            
            <form method="GET" class="d-flex flex-wrap gap-2">
                <!-- Preserve filters -->
                {% for branch in selected_branches %}
                <input type="hidden" name="branch" value="{{ branch }}">
                {% endfor %}
                {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
                {% endif %}

                <!-- Sort options based on batch -->
                {% if batch == "2024" %}
                    {% set sort_options = [
                        ("Rank", "Rank (Avg YGPA)"),
                        ("yGPA 1", "yGPA 1"),
                        ("SGPA 1", "SGPA 1"),
                        ("SGPA 2", "SGPA 2")
                    ] %}
                {% elif batch == "2023" %}
                    {% set sort_options = [
                        ("Rank", "Rank (Avg YGPA)"),
                        ("YGPA 1", "YGPA 1"),
                        ("YGPA 2", "YGPA 2"),
                        ("SGPA 1", "SGPA 1"),
                        ("SGPA 2", "SGPA 2"),
                        ("SGPA 3", "SGPA 3"),
                        ("SGPA 4", "SGPA 4")
                    ] %}
                {% elif batch == "2022" %}
                    {% set sort_options = [
                        ("Rank", "Rank (Avg YGPA)"),
                        ("YGPA 1", "YGPA 1"),
                        ("YGPA 2", "YGPA 2"),
                        ("YGPA 3", "YGPA 3"),
                        ("SGPA 1", "SGPA 1"),
                        ("SGPA 2", "SGPA 2"),
                        ("SGPA 3", "SGPA 3"),
                        ("SGPA 4", "SGPA 4"),
                        ("SGPA 5", "SGPA 5"),
                        ("SGPA 6", "SGPA 6")
                    ] %}
                {% endif %}

                {% for value, label in sort_options %}
                <button 
                    type="submit" 
                    name="sort_by" 
                    value="{{ value }}"
                    class="btn btn-sort {{ 'active' if sort_by == value else '' }}"
                >
                    {{ label }}
                    {% if sort_by == value %}
                        <i class="fas fa-sort-{{ 'down' if order == 'desc' else 'up' }} ms-1"></i>
                    {% endif %}
                </button>
                {% endfor %}

                <!-- Order toggle -->
                {% if sort_by %}
                <button 
                    type="submit" 
                    name="order" 
                    value="{{ 'asc' if order == 'desc' else 'desc' }}"
                    class="btn btn-filter"
                >
                    <i class="fas fa-exchange-alt me-1"></i>
                    {{ 'Ascending' if order == 'desc' else 'Descending' }}
                </button>
                {% endif %}
            </form>
        </div>

        <!-- Results Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-nord">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>{{ 'Branch' if 'Branch' in data[0] else 'Department' }}</th>
                            
                            <!-- Dynamic headers based on batch -->
                            {% if batch == "2024" %}
                                <th>yGPA 1</th>
                                <th>SGPA 1</th>
                                <th>SGPA 2</th>
                            {% elif batch == "2023" %}
                                <th>YGPA 1</th>
                                <th>YGPA 2</th>
                                <th>Avg YGPA</th>
                                <th>SGPA 1</th>
                                <th>SGPA 2</th>
                                <th>SGPA 3</th>
                                <th>SGPA 4</th>
                            {% elif batch == "2022" %}
                                <th>YGPA 1</th>
                                <th>YGPA 2</th>
                                <th>YGPA 3</th>
                                <th>Avg YGPA</th>
                                <th>SGPA 1</th>
                                <th>SGPA 2</th>
                                <th>SGPA 3</th>
                                <th>SGPA 4</th>
                                <th>SGPA 5</th>
                                <th>SGPA 6</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td><strong>{{ row.Rank }}</strong></td>
                            <td><strong>{{ row.Name }}</strong></td>
                            <td>{{ row.get('Branch', row.get('Department', 'N/A')) }}</td>
                            
                            <!-- Dynamic data based on batch -->
                            {% if batch == "2024" %}
                                <td>{{ row.get('yGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 2', 'N/A') }}</td>
                            {% elif batch == "2023" %}
                                <td>{{ row.get('YGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 2', 'N/A') }}</td>
                                <td>
                                    {% set ygpa1 = row.get('YGPA 1', 0) | float %}
                                    {% set ygpa2 = row.get('YGPA 2', 0) | float %}
                                    {{ "%.2f" | format((ygpa1 + ygpa2) / 2) if ygpa1 and ygpa2 else 'N/A' }}
                                </td>
                                <td>{{ row.get('SGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 3', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 4', 'N/A') }}</td>
                            {% elif batch == "2022" %}
                                <td>{{ row.get('YGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('YGPA 3', 'N/A') }}</td>
                                <td>
                                    {% set ygpa1 = row.get('YGPA 1', 0) | float %}
                                    {% set ygpa2 = row.get('YGPA 2', 0) | float %}
                                    {% set ygpa3 = row.get('YGPA 3', 0) | float %}
                                    {{ "%.2f" | format((ygpa1 + ygpa2 + ygpa3) / 3) if ygpa1 and ygpa2 and ygpa3 else 'N/A' }}
                                </td>
                                <td>{{ row.get('SGPA 1', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 2', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 3', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 4', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 5', 'N/A') }}</td>
                                <td>{{ row.get('SGPA 6', 'N/A') }}</td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="20" class="text-center text-muted">
                                <i class="fas fa-search me-2"></i>No results found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Results Summary -->
        {% if data %}
        <div class="mt-4 text-center">
            <small class="text-muted">
                Showing {{ data|length }} result{{ 's' if data|length != 1 else '' }}
                {% if search_query %}for search "{{ search_query }}"{% endif %}
                {% if selected_branches %}in {{ selected_branches|join(', ') }}{% endif %}
            </small>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add some interactivity for better UX
document.addEventListener('DOMContentLoaded', function() {
    // Add loading state to buttons
    const buttons = document.querySelectorAll('button[type="submit"]');
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
            this.disabled = true;
            
            // Re-enable after a short delay if navigation doesn't happen
            setTimeout(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            }, 3000);
        });
    });
    
    // Auto-submit search form on Enter
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.closest('form').submit();
            }
        });
    }
});
</script>
{% endblock %}
